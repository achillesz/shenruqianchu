"use strict";

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.default = readfile;

var _fs = require("fs");

var _fs2 = _interopRequireDefault(_fs);

var _path = require("path");

var _path2 = _interopRequireDefault(_path);

var _asyncList = require("./async-list");

var _asyncList2 = _interopRequireDefault(_asyncList);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var sep = _path2.default.sep;

var ignore = [];

function readfile(dir, ext, isDeep, callback) {
	var files = [];

	// if(/node_modules/.test(dir)){
	// 	callback(files);
	// 	return;
	// }

	dir = dir.replace(/(\/|\\)$/, "");

	_fs2.default.readdir(dir, function (err, _files) {
		if (err) {
			throw err;
		}

		var dirs = [],
		    readStatList = [];
		_files.forEach(function (filename) {
			// if(/^\./.test(filename)){
			// 	return;
			// }
			if (ignore.indexOf(filename) !== -1) {
				return;
			}

			var file = dir + sep + filename;

			readStatList.push(function (callback) {
				_fs2.default.stat(file, function (err, stats) {
					if (err) {
						throw err;
					}

					var _ext = _path2.default.extname(filename);

					if (stats.isDirectory()) {
						dirs.push(function (callback) {
							readfile(file, ext, isDeep, function (_files) {
								files = files.concat(_files);
								callback();
							});
						});
						if (ext === "/") {
							files.push(file);
						}
					} else {
						if (ext) {
							if (_ext === ext) {
								files.push(file);
							}
						} else {
							files.push(file);
						}
					}
					callback();
				});
			});
		});

		(0, _asyncList2.default)(readStatList).then(function () {
			if (isDeep && dirs.length) {
				(0, _asyncList2.default)(dirs).then(function () {
					callback(files);
				});
			} else {
				callback(files);
			}
		});
	});
};